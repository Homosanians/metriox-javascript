"use strict";var MetrioxTG=(()=>{var y=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var A=(e,n)=>{for(var t in n)y(e,t,{get:n[t],enumerable:!0})},P=(e,n,t,o)=>{if(n&&typeof n=="object"||typeof n=="function")for(let u of D(n))!R.call(e,u)&&u!==t&&y(e,u,{get:()=>n[u],enumerable:!(o=L(n,u))||o.enumerable});return e};var T=e=>P(y({},"__esModule",{value:!0}),e);var V={};A(V,{init:()=>B,mergeAuto:()=>O,splitProps:()=>j});var x="https://ingest.metriox.com/tg/webapp",q="metriox-tg-webapp",C="1.0.0",p={flushMs:5e3,maxBatch:20,maxQueue:500,retryBaseMs:400,retryCount:2,auto:!1};function N(e){return new Promise(n=>setTimeout(n,e))}function F(){let e=globalThis.crypto;return e!=null&&e.randomUUID?e.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let t;return e!=null&&e.getRandomValues?t=e.getRandomValues(new Uint8Array(1))[0]&15:t=Math.floor(Math.random()*16),(n==="x"?t:t&3|8).toString(16)})}function h(e,n){return typeof e!="string"||e.length<=n?e:e.slice(0,n)}function j(e){let n={},t={},o={};if(!e)return{};for(let[i,r]of Object.entries(e))if(r!=null){if(typeof r=="string"){n[i]=h(r,2048);continue}if(typeof r=="boolean"){o[i]=r;continue}if(typeof r=="number"){Number.isInteger(r)&&Number.isSafeInteger(r)?t[i]=r:n[i]=h(String(r),2048);continue}try{n[i]=h(JSON.stringify(r),2048)}catch{n[i]=h(String(r),2048)}}let u={};return Object.keys(n).length&&(u.PropsString=n),Object.keys(t).length&&(u.PropsLong=t),Object.keys(o).length&&(u.PropsBool=o),u}function O(e){return e===!0?{page:!0,nav:!0,clicks:!0,forms:!0,errors:!0}:e?{page:!!e.page,nav:!!e.nav,clicks:!!e.clicks,forms:!!e.forms,errors:!!e.errors}:{page:!1,nav:!1,clicks:!1,forms:!1,errors:!1}}function Q(e){try{return new URL(e,location.href).origin===location.origin}catch{return!1}}async function U(e,n,t){if(Q(x))try{if(navigator.sendBeacon){let o=new Blob([JSON.stringify(e)],{type:"application/json"});if(navigator.sendBeacon(x,o))return!0}}catch{}for(let o=0;o<=n;o++){try{if((await fetch(x,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(e),keepalive:!0,credentials:"omit"})).ok)return!0}catch{}o<n&&await N(t*Math.pow(2,o))}return!1}function _(e,n){let t=O(n),o=[];if(t.page&&e.page("page_view",{path:location.pathname+location.search,title:document.title}),t.nav){let r=function(){e.page("navigation",{path:location.pathname+location.search,title:document.title})};var u=r;let i=history.pushState;history.pushState=function(){i.apply(history,arguments),r()};let a=()=>r();window.addEventListener("popstate",a),o.push(()=>{history.pushState=i,window.removeEventListener("popstate",a)})}if(t.clicks){let i=r=>{var l,f;let a=(f=(l=r.target)==null?void 0:l.closest)==null?void 0:f.call(l,"[data-mx]");a&&e.interaction("click",{mx:a.getAttribute("data-mx")||"",tag:a.tagName,id:a.id||""})};document.addEventListener("click",i,!0),o.push(()=>document.removeEventListener("click",i,!0))}if(t.forms){let i=r=>{let a=r.target;a instanceof HTMLFormElement&&e.interaction("form_submit",{formId:a.id||"",method:a.method||"",action:a.action||""})};document.addEventListener("submit",i,!0),o.push(()=>document.removeEventListener("submit",i,!0))}if(t.errors){let i=a=>{e.track("error_unhandled",{message:a.message||"",source:a.filename||"",line:a.lineno||0,col:a.colno||0})},r=a=>{var l;e.track("promise_rejection",{message:String(((l=a.reason)==null?void 0:l.message)||a.reason||"")})};window.addEventListener("error",i),window.addEventListener("unhandledrejection",r),o.push(()=>{window.removeEventListener("error",i),window.removeEventListener("unhandledrejection",r)})}return function(){for(let r of o)try{r()}catch{}}}function B(e){var v,E,w,k,S,I;if(!(e!=null&&e.projectId)||!(e!=null&&e.botId))throw new Error("projectId and botId required");let n={flushMs:(v=e.flushMs)!=null?v:p.flushMs,maxBatch:(E=e.maxBatch)!=null?E:p.maxBatch,maxQueue:(w=e.maxQueue)!=null?w:p.maxQueue,retryBaseMs:(k=e.retryBaseMs)!=null?k:p.retryBaseMs,retryCount:(S=e.retryCount)!=null?S:p.retryCount,auto:(I=e.auto)!=null?I:p.auto},t={projectId:e.projectId,botId:e.botId,auth:e.auth,queue:[],timer:null,flushing:!1,alive:!0,cleanupFns:[]};function o(s){let c=Object.assign({},s);return c.sdk=q,c.sdk_version=C,c}function u(){!t.alive||t.timer||(t.timer=setTimeout(()=>{t.timer=null,l()},n.flushMs))}function i(s){t.alive&&(t.queue.length>=n.maxQueue&&t.queue.splice(0,t.queue.length-n.maxQueue+1),t.queue.push(s),t.queue.length>=n.maxBatch?l():u())}function r(s,c,m,d){i({EventId:F(),EventType:String(s),EventName:String(c),EventDate:new Date().toISOString(),Text:d,...j(o(m))})}async function a(){var s,c,m,d,M;if(typeof t.auth=="function"){let g=await t.auth();return(s=g==null?void 0:g.initData)!=null?s:""}return t.auth&&typeof t.auth=="object"?(c=t.auth.initData)!=null?c:"":(M=(d=(m=globalThis.Telegram)==null?void 0:m.WebApp)==null?void 0:d.initData)!=null?M:""}async function l(){if(!(!t.alive||t.flushing||!t.queue.length)){t.flushing=!0;try{let s=t.queue.splice(0,n.maxBatch),c=await a(),m={ProjectId:t.projectId,BotId:t.botId,Auth:{InitData:c||""},Events:s};await U(m,n.retryCount,n.retryBaseMs)?t.queue.length&&u():(t.queue=s.concat(t.queue),u())}finally{t.flushing=!1}}}let f={track(s,c,m){r("custom",s,c,m==null?void 0:m.text)},page(s,c){r("page",s,c)},interaction(s,c){r("interaction",s,c)},flush:l,shutdown(){t.alive=!1,t.timer&&clearTimeout(t.timer),t.timer=null;for(let s of t.cleanupFns)try{s()}catch{}t.cleanupFns=[]}};n.auto&&t.cleanupFns.push(_(f,n.auto));let b=()=>{document.visibilityState==="hidden"&&f.flush()};return document.addEventListener("visibilitychange",b),t.cleanupFns.push(()=>document.removeEventListener("visibilitychange",b)),f}globalThis.MetrioxTG={init:B};return T(V);})();
//# sourceMappingURL=metriox-tg-webapp.min.js.map
