(()=>{(function(y){"use strict";let h="https://ingest.metriox.com/tg/webapp",v="metriox-tg-webapp",b="1.0.0",c={flushMs:5e3,maxBatch:20,maxQueue:500,retryBaseMs:400,retryCount:2,auto:!1};function w(t){return new Promise(r=>setTimeout(r,t))}function S(){return crypto?.randomUUID?.()??("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16))}function f(t,r){return typeof t!="string"||t.length<=r?t:t.slice(0,r)}function k(t){let r={},e={},i={};if(!t)return{};for(let[s,n]of Object.entries(t))if(n!=null){if(typeof n=="string"){r[s]=f(n,2048);continue}if(typeof n=="boolean"){i[s]=n;continue}if(typeof n=="number"){Number.isInteger(n)&&Number.isSafeInteger(n)?e[s]=n:r[s]=f(String(n),2048);continue}try{r[s]=f(JSON.stringify(n),2048)}catch{r[s]=f(String(n),2048)}}let o={};return Object.keys(r).length&&(o.PropsString=r),Object.keys(e).length&&(o.PropsLong=e),Object.keys(i).length&&(o.PropsBool=i),o}function E(t){return t===!0?{page:!0,nav:!0,clicks:!0,forms:!0,errors:!0}:t?{page:!!t.page,nav:!!t.nav,clicks:!!t.clicks,forms:!!t.forms,errors:!!t.errors}:{page:!1,nav:!1,clicks:!1,forms:!1,errors:!1}}async function I(t,r,e){try{if(navigator.sendBeacon){let i=new Blob([JSON.stringify(t)],{type:"application/json"});if(navigator.sendBeacon(h,i))return!0}}catch{}for(let i=0;i<=r;i++){try{if((await fetch(h,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(t),keepalive:!0})).ok)return!0}catch{}if(i<r){let o=e*Math.pow(2,i);await w(o)}}return!1}function x(t,r){let e=E(r),i=[];if(e.page&&t.page("page_view",{path:location.pathname+location.search,title:document.title}),e.nav){let s=function(){t.page("navigation",{path:location.pathname+location.search,title:document.title})},o=history.pushState;history.pushState=function(){o.apply(history,arguments),s()};let n=()=>s();window.addEventListener("popstate",n),i.push(()=>{history.pushState=o,window.removeEventListener("popstate",n)})}if(e.clicks){let o=s=>{let n=s.target?.closest?.("[data-mx]");n&&t.interaction("click",{mx:n.getAttribute("data-mx")||"",tag:n.tagName,id:n.id||""})};document.addEventListener("click",o,!0),i.push(()=>document.removeEventListener("click",o,!0))}if(e.forms){let o=s=>{let n=s.target;n instanceof HTMLFormElement&&t.interaction("form_submit",{formId:n.id||"",method:n.method||"",action:n.action||""})};document.addEventListener("submit",o,!0),i.push(()=>document.removeEventListener("submit",o,!0))}if(e.errors){let o=n=>{t.track("error_unhandled",{message:n.message||"",source:n.filename||"",line:n.lineno||0,col:n.colno||0})},s=n=>{t.track("promise_rejection",{message:String(n.reason?.message||n.reason||"")})};window.addEventListener("error",o),window.addEventListener("unhandledrejection",s),i.push(()=>{window.removeEventListener("error",o),window.removeEventListener("unhandledrejection",s)})}return function(){for(let s of i)try{s()}catch{}}}function j(t){if(!t?.projectId||!t?.botId)throw new Error("projectId and botId required");let r={flushMs:t.flushMs??c.flushMs,maxBatch:t.maxBatch??c.maxBatch,maxQueue:t.maxQueue??c.maxQueue,retryBaseMs:t.retryBaseMs??c.retryBaseMs,retryCount:t.retryCount??c.retryCount,auto:t.auto??c.auto},e={projectId:t.projectId,botId:t.botId,auth:t.auth,queue:[],timer:null,flushing:!1,alive:!0,cleanupFns:[]};function i(a){let u=Object.assign({},a);return u.sdk=v,u.sdk_version=b,u}function o(){e.alive&&(e.timer||(e.timer=setTimeout(()=>{e.timer=null,m()},r.flushMs)))}function s(a){e.alive&&(e.queue.length>=r.maxQueue&&e.queue.splice(0,e.queue.length-r.maxQueue+1),e.queue.push(a),e.queue.length>=r.maxBatch?m():o())}function n(a,u,l,g){let B={EventId:S(),EventType:String(a),EventName:String(u),EventDate:new Date().toISOString(),Text:g,...k(i(l))};s(B)}async function m(){if(e.alive&&!e.flushing&&e.queue.length){e.flushing=!0;try{let a=e.queue.splice(0,r.maxBatch),u=typeof e.auth=="function"?await e.auth():e.auth||{},l={ProjectId:e.projectId,BotId:e.botId,Auth:{Statement:u.statement||"",Signature:u.signature||""},Events:a};await I(l,r.retryCount,r.retryBaseMs)?e.queue.length&&o():(e.queue=a.concat(e.queue),o())}finally{e.flushing=!1}}}let p={track(a,u,l){n("custom",`custom:${a}`,u,l?.text)},page(a,u){n("page",a,u)},interaction(a,u){n("interaction",a,u)},flush:m,shutdown(){e.alive=!1,e.timer&&clearTimeout(e.timer),e.timer=null;for(let a of e.cleanupFns)try{a()}catch{}e.cleanupFns=[]}};if(r.auto){let a=x(p,r.auto);e.cleanupFns.push(a)}let d=()=>{document.visibilityState==="hidden"&&p.flush()};return document.addEventListener("visibilitychange",d),e.cleanupFns.push(()=>document.removeEventListener("visibilitychange",d)),p}y.MetrioxTG={init:j}})(window);})();
