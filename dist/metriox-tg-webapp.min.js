(()=>{(function(y){"use strict";let m="https://ingest.metriox.com/tg/webapp",v="metriox-tg-webapp",b="1.0.0",c={flushMs:5e3,maxBatch:20,maxQueue:500,retryBaseMs:400,retryCount:2,auto:!1};function w(e){return new Promise(r=>setTimeout(r,e))}function S(){return crypto?.randomUUID?.()??("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function f(e,r){return typeof e!="string"||e.length<=r?e:e.slice(0,r)}function k(e){let r={},t={},s={};if(!e)return{};for(let[i,n]of Object.entries(e))if(n!=null){if(typeof n=="string"){r[i]=f(n,2048);continue}if(typeof n=="boolean"){s[i]=n;continue}if(typeof n=="number"){Number.isInteger(n)&&Number.isSafeInteger(n)?t[i]=n:r[i]=f(String(n),2048);continue}try{r[i]=f(JSON.stringify(n),2048)}catch{r[i]=f(String(n),2048)}}let o={};return Object.keys(r).length&&(o.PropsString=r),Object.keys(t).length&&(o.PropsLong=t),Object.keys(s).length&&(o.PropsBool=s),o}function E(e){return e===!0?{page:!0,nav:!0,clicks:!0,forms:!0,errors:!0}:e?{page:!!e.page,nav:!!e.nav,clicks:!!e.clicks,forms:!!e.forms,errors:!!e.errors}:{page:!1,nav:!1,clicks:!1,forms:!1,errors:!1}}function I(e){try{return new URL(e,location.href).origin===location.origin}catch{return!1}}async function x(e,r,t){if(I(m))try{if(navigator.sendBeacon){let s=new Blob([JSON.stringify(e)],{type:"application/json"});if(navigator.sendBeacon(m,s))return!0}}catch{}for(let s=0;s<=r;s++){try{if((await fetch(m,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(e),keepalive:!0,credentials:"omit"})).ok)return!0}catch{}s<r&&await w(t*Math.pow(2,s))}return!1}function j(e,r){let t=E(r),s=[];if(t.page&&e.page("page_view",{path:location.pathname+location.search,title:document.title}),t.nav){let i=function(){e.page("navigation",{path:location.pathname+location.search,title:document.title})},o=history.pushState;history.pushState=function(){o.apply(history,arguments),i()};let n=()=>i();window.addEventListener("popstate",n),s.push(()=>{history.pushState=o,window.removeEventListener("popstate",n)})}if(t.clicks){let o=i=>{let n=i.target?.closest?.("[data-mx]");n&&e.interaction("click",{mx:n.getAttribute("data-mx")||"",tag:n.tagName,id:n.id||""})};document.addEventListener("click",o,!0),s.push(()=>document.removeEventListener("click",o,!0))}if(t.forms){let o=i=>{let n=i.target;n instanceof HTMLFormElement&&e.interaction("form_submit",{formId:n.id||"",method:n.method||"",action:n.action||""})};document.addEventListener("submit",o,!0),s.push(()=>document.removeEventListener("submit",o,!0))}if(t.errors){let o=n=>{e.track("error_unhandled",{message:n.message||"",source:n.filename||"",line:n.lineno||0,col:n.colno||0})},i=n=>{e.track("promise_rejection",{message:String(n.reason?.message||n.reason||"")})};window.addEventListener("error",o),window.addEventListener("unhandledrejection",i),s.push(()=>{window.removeEventListener("error",o),window.removeEventListener("unhandledrejection",i)})}return function(){for(let i of s)try{i()}catch{}}}function B(e){if(!e?.projectId||!e?.botId)throw new Error("projectId and botId required");let r={flushMs:e.flushMs??c.flushMs,maxBatch:e.maxBatch??c.maxBatch,maxQueue:e.maxQueue??c.maxQueue,retryBaseMs:e.retryBaseMs??c.retryBaseMs,retryCount:e.retryCount??c.retryCount,auto:e.auto??c.auto},t={projectId:e.projectId,botId:e.botId,auth:e.auth,queue:[],timer:null,flushing:!1,alive:!0,cleanupFns:[]};function s(a){let u=Object.assign({},a);return u.sdk=v,u.sdk_version=b,u}function o(){t.alive&&(t.timer||(t.timer=setTimeout(()=>{t.timer=null,h()},r.flushMs)))}function i(a){t.alive&&(t.queue.length>=r.maxQueue&&t.queue.splice(0,t.queue.length-r.maxQueue+1),t.queue.push(a),t.queue.length>=r.maxBatch?h():o())}function n(a,u,l,g){let L={EventId:S(),EventType:String(a),EventName:String(u),EventDate:new Date().toISOString(),Text:g,...k(s(l))};i(L)}async function h(){if(t.alive&&!t.flushing&&t.queue.length){t.flushing=!0;try{let a=t.queue.splice(0,r.maxBatch),u=typeof t.auth=="function"?await t.auth():t.auth||{},l={ProjectId:t.projectId,BotId:t.botId,Auth:{Statement:u.statement||"",Signature:u.signature||""},Events:a};await x(l,r.retryCount,r.retryBaseMs)?t.queue.length&&o():(t.queue=a.concat(t.queue),o())}finally{t.flushing=!1}}}let p={track(a,u,l){n("custom",`custom:${a}`,u,l?.text)},page(a,u){n("page",a,u)},interaction(a,u){n("interaction",a,u)},flush:h,shutdown(){t.alive=!1,t.timer&&clearTimeout(t.timer),t.timer=null;for(let a of t.cleanupFns)try{a()}catch{}t.cleanupFns=[]}};if(r.auto){let a=j(p,r.auto);t.cleanupFns.push(a)}let d=()=>{document.visibilityState==="hidden"&&p.flush()};return document.addEventListener("visibilitychange",d),t.cleanupFns.push(()=>document.removeEventListener("visibilitychange",d)),p}y.MetrioxTG={init:B}})(window);})();
